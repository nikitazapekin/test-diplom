<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            height: 70vh;
        }

        .preview-area {
            position: relative;
            height: 45%;
            background-size: cover;
            background-position: center;
            border-bottom: 3px solid #333;
            cursor: pointer;
            overflow: hidden;
        }

        .character {
            position: absolute;
            bottom: 0;
            height: 85%;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
        }

        .character-left {
            left: 50px;
        }

        .character-right {
            right: 50px;
        }

        .dialog-box {
            position: absolute;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            min-height: 70px;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.4;
        }

        .dialog-box.active {
            opacity: 1;
            transform: translateY(0);
        }

        .dialog-box-left {
            left: 220px;
            border-left: 5px solid #3498db;
        }

        .dialog-box-right {
            right: 220px;
            border-left: 5px solid #e74c3c;
        }

        .timeline-container {
            height: 55%;
            display: flex;
            flex-direction: column;
            background: #ecf0f1;
            border-top: 2px solid #bdc3c7;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #34495e;
            color: white;
        }

        .timeline-controls button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

        .timeline-controls button:hover {
            background: #2980b9;
        }

        .timeline {
            flex: 1;
            background: #2c3e50;
            position: relative;
            overflow: hidden;
        }

        .ruler {
            height: 30px;
            background: #34495e;
            border-bottom: 1px solid #7f8c8d;
            position: relative;
        }

        .time-marker {
            position: absolute;
            height: 100%;
            width: 1px;
            background: rgba(255, 255, 255, 0.3);
            top: 0;
        }

        .time-marker span {
            position: absolute;
            top: 5px;
            left: 2px;
            color: white;
            font-size: 10px;
        }

        .tracks {
            display: flex;
            flex-direction: column;
            height: calc(100% - 30px);
        }

        .track {
            display: flex;
            height: 80px;
            border-bottom: 1px solid #7f8c8d;
            position: relative;
        }

        .track-label {
            width: 120px;
            background: #34495e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .track-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .clip {
            position: absolute;
            height: 70px;
            top: 5px;
            border-radius: 5px;
            cursor: grab;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.3s ease;
            user-select: none;
        }

        .clip:active {
            cursor: grabbing;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .dialogue-clip {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }

        .sfx-clip {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }

        .clip-handle {
            width: 10px;
            height: 100%;
            position: absolute;
            top: 0;
            cursor: col-resize;
            background: rgba(0, 0, 0, 0.2);
        }

        .clip-handle-left {
            left: 0;
            border-radius: 5px 0 0 5px;
        }

        .clip-handle-right {
            right: 0;
            border-radius: 0 5px 5px 0;
        }

        .playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #e74c3c;
            z-index: 10;
            pointer-events: none;
        }

        .playhead::after {
            content: '';
            position: absolute;
            top: 0;
            left: -5px;
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
        }

        .controls {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            background: #f8f9fa;
        }

        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        select, input, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #2980b9;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container label {
            min-width: 80px;
        }

        input[type="range"] {
            margin: 0;
        }

        .voice-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .current-step {
            text-align: center;
            padding: 10px;
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .speech-input {
            min-height: 80px;
            resize: vertical;
        }

        .clip-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .mini-btn {
            padding: 5px;
            font-size: 12px;
            margin: 0;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è */
        @keyframes playing {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .playing {
            animation: playing 0.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üé¨ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤ PRO</div>
            <div class="timeline-controls">
                <button id="playBtn">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                <button id="pauseBtn">‚è∏ –ü–∞—É–∑–∞</button>
                <button id="stopBtn">‚èπ –°—Ç–æ–ø</button>
                <button id="exportBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="preview-area" id="previewArea">
                <img class="character character-left" id="characterLeft" src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=400" alt="–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ª–µ–≤–∞">
                <img class="character character-right" id="characterRight" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400" alt="–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ø—Ä–∞–≤–∞">
                
                <div class="dialog-box dialog-box-left" id="dialogLeft">
                    <div class="dialog-text"></div>
                </div>
                
                <div class="dialog-box dialog-box-right" id="dialogRight">
                    <div class="dialog-text"></div>
                </div>
            </div>

            <div class="timeline-container">
                <div class="timeline-header">
                    <div>–¢–∞–π–º–ª–∞–π–Ω</div>
                    <div>–ú–∞—Å—à—Ç–∞–±: <input type="range" id="zoomSlider" min="1" max="100" value="10"></div>
                </div>
                <div class="timeline">
                    <div class="ruler" id="ruler"></div>
                    <div class="tracks">
                        <div class="track">
                            <div class="track-label">–î–∏–∞–ª–æ–≥–∏</div>
                            <div class="track-content" id="dialogueTrack"></div>
                        </div>
                        <div class="track">
                            <div class="track-label">–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                            <div class="track-content" id="sfxTrack"></div>
                        </div>
                    </div>
                    <div class="playhead" id="playhead"></div>
                </div>
            </div>
        </div>

        <div class="current-step" id="currentStep">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω.</div>

        <div class="controls">
            <div class="control-group">
                <h2>–§–æ–Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞</h2>
                <select id="backgroundSelect">
                    <option value="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800">–ì–æ—Ä—ã</option>
                    <option value="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800">–õ–µ—Å–∞</option>
                    <option value="https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=800">–û–∫–µ–∞–Ω</option>
                    <option value="https://images.unsplash.com/photo-1515488764276-beab7607c1e6?w=800">–ì–æ—Ä–æ–¥</option>
                </select>
            </div>

            <div class="control-group">
                <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ª–µ–≤–∞</h2>
                <select id="leftCharacterSelect">
                    <option value="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=400">–ú—É–∂—á–∏–Ω–∞ 1</option>
                    <option value="https://images.unsplash.com/photo-1567532939604-b6b5b0db1604?w=400">–ñ–µ–Ω—â–∏–Ω–∞ 1</option>
                    <option value="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400">–ú—É–∂—á–∏–Ω–∞ 2</option>
                </select>
            </div>

            <div class="control-group">
                <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ø—Ä–∞–≤–∞</h2>
                <select id="rightCharacterSelect">
                    <option value="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400">–ñ–µ–Ω—â–∏–Ω–∞ 2</option>
                    <option value="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400">–ú—É–∂—á–∏–Ω–∞ 3</option>
                    <option value="https://images.unsplash.com/photo-1554151228-14d9def656e4?w=400">–ñ–µ–Ω—â–∏–Ω–∞ 3</option>
                </select>
            </div>

            <div class="control-group">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥</h2>
                <select id="dialogueCharacter">
                    <option value="left">–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ª–µ–≤–∞</option>
                    <option value="right">–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–ø—Ä–∞–≤–∞</option>
                </select>
                <textarea class="speech-input" id="dialogueText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–µ–ø–ª–∏–∫–∏..."></textarea>
                
                <div class="voice-options">
                    <div>
                        <label>–ì–æ–ª–æ—Å</label>
                        <select id="voiceSelect"></select>
                    </div>
                    <div>
                        <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
                        <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <div>
                        <label>–í—ã—Å–æ—Ç–∞</label>
                        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <div>
                        <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.8">
                    </div>
                </div>
                
                <button id="addDialogueBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω</button>
            </div>

            <div class="control-group">
                <h2>–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h2>
                <select id="sfxSelect">
                    <option value="bell">–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫</option>
                    <option value="drum">–ë–∞—Ä–∞–±–∞–Ω–Ω–∞—è –¥—Ä–æ–±—å</option>
                    <option value="applause">–ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã</option>
                    <option value="laugh">–°–º–µ—Ö</option>
                    <option value="suspense">–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ</option>
                </select>
                
                <div class="slider-container">
                    <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
                    <input type="range" id="sfxVolume" min="0" max="1" step="0.1" value="0.7">
                </div>
                
                <button id="addSfxBtn">üîä –î–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç</button>
            </div>

            <div class="control-group">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º</h2>
                <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                <button id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                <button id="resetBtn">üóëÔ∏è –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
                
                <div class="clip-controls">
                    <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç:</h3>
                    <div id="clipInfo">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞</div>
                    <button class="mini-btn" id="deleteClipBtn">–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
                    <button class="mini-btn" id="duplicateClipBtn">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const previewArea = document.getElementById('previewArea');
        const characterLeft = document.getElementById('characterLeft');
        const characterRight = document.getElementById('characterRight');
        const dialogLeft = document.getElementById('dialogLeft');
        const dialogRight = document.getElementById('dialogRight');
        const backgroundSelect = document.getElementById('backgroundSelect');
        const leftCharacterSelect = document.getElementById('leftCharacterSelect');
        const rightCharacterSelect = document.getElementById('rightCharacterSelect');
        const dialogueText = document.getElementById('dialogueText');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateSlider = document.getElementById('rateSlider');
        const pitchSlider = document.getElementById('pitchSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const addDialogueBtn = document.getElementById('addDialogueBtn');
        const sfxSelect = document.getElementById('sfxSelect');
        const sfxVolume = document.getElementById('sfxVolume');
        const addSfxBtn = document.getElementById('addSfxBtn');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const exportBtn = document.getElementById('exportBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const deleteClipBtn = document.getElementById('deleteClipBtn');
        const duplicateClipBtn = document.getElementById('duplicateClipBtn');
        const zoomSlider = document.getElementById('zoomSlider');
        const ruler = document.getElementById('ruler');
        const dialogueTrack = document.getElementById('dialogueTrack');
        const sfxTrack = document.getElementById('sfxTrack');
        const playhead = document.getElementById('playhead');
        const currentStep = document.getElementById('currentStep');
        const dialogueCharacter = document.getElementById('dialogueCharacter');
        const clipInfo = document.getElementById('clipInfo');

        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let project = {
            dialogues: [],
            sfx: [],
            duration: 60, // seconds
            zoom: 10
        };
        
        let voices = [];
        let isPlaying = false;
        let playheadPosition = 0;
        let playbackInterval;
        let selectedClip = null;
        let currentAudio = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            updateBackground();
            updateCharacter('left');
            updateCharacter('right');
            loadVoices();
            drawRuler();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            backgroundSelect.addEventListener('change', updateBackground);
            leftCharacterSelect.addEventListener('change', () => updateCharacter('left'));
            rightCharacterSelect.addEventListener('change', () => updateCharacter('right'));
            addDialogueBtn.addEventListener('click', addDialogueToTimeline);
            addSfxBtn.addEventListener('click', addSfxToTimeline);
            playBtn.addEventListener('click', playTimeline);
            pauseBtn.addEventListener('click', pauseTimeline);
            stopBtn.addEventListener('click', stopTimeline);
            exportBtn.addEventListener('click', exportProject);
            saveBtn.addEventListener('click', saveProject);
            loadBtn.addEventListener('click', loadProject);
            resetBtn.addEventListener('click', resetProject);
            deleteClipBtn.addEventListener('click', deleteSelectedClip);
            duplicateClipBtn.addEventListener('click', duplicateSelectedClip);
            zoomSlider.addEventListener('input', updateZoom);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤
            speechSynthesis.addEventListener('voiceschanged', loadVoices);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            initAudioContext();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
            pauseBtn.disabled = true;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞
        function updateBackground() {
            previewArea.style.backgroundImage = `url('${backgroundSelect.value}')`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        function updateCharacter(side) {
            if (side === 'left') {
                characterLeft.src = leftCharacterSelect.value;
            } else {
                characterRight.src = rightCharacterSelect.value;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '';
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≥–æ–ª–æ—Å–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
            const russianVoices = voices.filter(voice => 
                voice.lang.includes('ru') || voice.lang.includes('RU'));
            
            if (russianVoices.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ä—É—Å—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            } else {
                russianVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–Ω–µ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
        function drawRuler() {
            ruler.innerHTML = '';
            const seconds = project.duration;
            const zoom = project.zoom;
            
            for (let i = 0; i <= seconds; i++) {
                if (i % 5 === 0) {
                    const marker = document.createElement('div');
                    marker.className = 'time-marker';
                    marker.style.left = `${i * zoom}px`;
                    
                    const label = document.createElement('span');
                    label.textContent = `${i}s`;
                    marker.appendChild(label);
                    
                    ruler.appendChild(marker);
                }
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω
        function addDialogueToTimeline() {
            const text = dialogueText.value.trim();
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–µ–ø–ª–∏–∫–∏!');
                return;
            }
            
            const dialogue = {
                id: Date.now(),
                type: 'dialogue',
                character: dialogueCharacter.value,
                text: text,
                voice: voiceSelect.value,
                rate: parseFloat(rateSlider.value),
                pitch: parseFloat(pitchSlider.value),
                volume: parseFloat(volumeSlider.value),
                start: findEmptySpace(),
                duration: Math.max(3, text.length / 5), // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å based on text length
                position: 0
            };
            
            project.dialogues.push(dialogue);
            renderDialogueClip(dialogue);
            dialogueText.value = '';
        }

        // –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω–µ
        function findEmptySpace() {
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –∏—â–µ–º –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            let maxEnd = 0;
            
            project.dialogues.forEach(dialogue => {
                maxEnd = Math.max(maxEnd, dialogue.start + dialogue.duration);
            });
            
            project.sfx.forEach(sfx => {
                maxEnd = Math.max(maxEnd, sfx.start + sfx.duration);
            });
            
            return maxEnd + 1; // –î–æ–±–∞–≤–ª—è–µ–º 1 —Å–µ–∫—É–Ω–¥—É –æ—Ç—Å—Ç—É–ø–∞
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        function addSfxToTimeline() {
            const sfx = {
                id: Date.now(),
                type: 'sfx',
                effect: sfxSelect.value,
                volume: parseFloat(sfxVolume.value),
                start: findEmptySpace(),
                duration: 3,
                position: 0
            };
            
            project.sfx.push(sfx);
            renderSfxClip(sfx);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∏–ø–∞ –¥–∏–∞–ª–æ–≥–∞
        function renderDialogueClip(dialogue) {
            const clip = document.createElement('div');
            clip.className = 'clip dialogue-clip';
            clip.id = `clip-${dialogue.id}`;
            clip.style.left = `${dialogue.start * project.zoom}px`;
            clip.style.width = `${dialogue.duration * project.zoom}px`;
            
            clip.innerHTML = `
                <div class="clip-handle clip-handle-left"></div>
                <div class="clip-content">${dialogue.character === 'left' ? 'üëà' : 'üëâ'} ${dialogue.text.substring(0, 20)}${dialogue.text.length > 20 ? '...' : ''}</div>
                <div class="clip-handle clip-handle-right"></div>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            makeClipDraggable(clip, dialogue);
            
            dialogueTrack.appendChild(clip);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∏–ø–∞ –∑–≤—É–∫–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        function renderSfxClip(sfx) {
            const clip = document.createElement('div');
            clip.className = 'clip sfx-clip';
            clip.id = `sfx-${sfx.id}`;
            clip.style.left = `${sfx.start * project.zoom}px`;
            clip.style.width = `${sfx.duration * project.zoom}px`;
            
            clip.innerHTML = `
                <div class="clip-handle clip-handle-left"></div>
                <div class="clip-content">üîä ${sfx.effect}</div>
                <div class="clip-handle clip-handle-right"></div>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            makeClipDraggable(clip, sfx);
            
            sfxTrack.appendChild(clip);
        }

        // –°–¥–µ–ª–∞—Ç—å –∫–ª–∏–ø –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
        function makeClipDraggable(clip, item) {
            clip.addEventListener('mousedown', (e) => {
                selectedClip = item;
                updateClipInfo();
                
                // –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                const startX = e.clientX;
                const startLeft = parseInt(clip.style.left);
                
                function onMouseMove(e) {
                    const dx = e.clientX - startX;
                    const newLeft = Math.max(0, startLeft + dx);
                    clip.style.left = `${newLeft}px`;
                    item.start = newLeft / project.zoom;
                }
                
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                e.preventDefault();
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–ª–∏–ø–µ
        function updateClipInfo() {
            if (!selectedClip) {
                clipInfo.textContent = '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞';
                return;
            }
            
            if (selectedClip.type === 'dialogue') {
                clipInfo.textContent = `–î–∏–∞–ª–æ–≥: ${selectedClip.text.substring(0, 30)}...`;
            } else {
                clipInfo.textContent = `SFX: ${selectedClip.effect}, –ì—Ä–æ–º–∫–æ—Å—Ç—å: ${selectedClip.volume}`;
            }
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–∞–π–º–ª–∞–π–Ω–∞
        function playTimeline() {
            if (isPlaying) return;
            
            isPlaying = true;
            playBtn.disabled = true;
            pauseBtn.disabled = false;
            currentStep.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...';
            
            let currentTime = playheadPosition;
            
            playbackInterval = setInterval(() => {
                currentTime += 0.1;
                playheadPosition = currentTime;
                playhead.style.left = `${currentTime * project.zoom}px`;
                
                // Check for dialogues and SFX to play
                playItemsAtTime(currentTime);
                
                if (currentTime >= project.duration) {
                    stopTimeline();
                }
            }, 100);
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        function playItemsAtTime(time) {
            // –î–∏–∞–ª–æ–≥–∏
            project.dialogues.forEach(dialogue => {
                if (Math.abs(dialogue.start - time) < 0.1) {
                    playDialogue(dialogue);
                }
            });
            
            // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            project.sfx.forEach(sfx => {
                if (Math.abs(sfx.start - time) < 0.1) {
                    playSfx(sfx);
                }
            });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        function playDialogue(dialogue) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏
            dialogLeft.classList.remove('active');
            dialogRight.classList.remove('active');
            
            setTimeout(() => {
                if (dialogue.character === 'left') {
                    dialogLeft.querySelector('.dialog-text').textContent = dialogue.text;
                    dialogLeft.classList.add('active');
                } else {
                    dialogRight.querySelector('.dialog-text').textContent = dialogue.text;
                    dialogRight.classList.add('active');
                }
                
                // –û–∑–≤—É—á–∫–∞
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(dialogue.text);
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞
                    const voice = voices.find(v => v.name === dialogue.voice);
                    if (voice) utterance.voice = voice;
                    
                    utterance.rate = dialogue.rate;
                    utterance.pitch = dialogue.pitch;
                    utterance.volume = dialogue.volume;
                    
                    speechSynthesis.speak(utterance);
                }
            }, 300);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        function initAudioContext() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                window.audioContext = new AudioContext();
            } catch (e) {
                console.warn('Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
            }
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        function playSfx(sfx) {
            if (!window.audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            switch(sfx.effect) {
                case 'bell':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 1);
                    break;
                case 'drum':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                    break;
                case 'applause':
                    // –ò–º–∏—Ç–∞—Ü–∏—è –∞–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç–æ–≤
                    for (let i = 0; i < 5; i++) {
                        const clap = audioContext.createOscillator();
                        clap.type = 'sine';
                        clap.frequency.setValueAtTime(1000 + Math.random() * 500, audioContext.currentTime + i * 0.2);
                        clap.connect(gainNode);
                        clap.start(audioContext.currentTime + i * 0.2);
                        clap.stop(audioContext.currentTime + i * 0.2 + 0.1);
                    }
                    break;
                case 'laugh':
                    oscillator.type = 'sine';
                    for (let i = 0; i < 5; i++) {
                        oscillator.frequency.setValueAtTime(500 + i * 100, audioContext.currentTime + i * 0.2);
                    }
                    break;
                case 'suspense':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 2);
                    break;
            }
            
            gainNode.gain.value = sfx.volume;
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        }

        // –ü–∞—É–∑–∞ —Ç–∞–π–º–ª–∞–π–Ω–∞
        function pauseTimeline() {
            if (!isPlaying) return;
            
            isPlaying = false;
            clearInterval(playbackInterval);
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            currentStep.textContent = '–ü–∞—É–∑–∞';
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–ª–∞–π–Ω–∞
        function stopTimeline() {
            isPlaying = false;
            clearInterval(playbackInterval);
            playheadPosition = 0;
            playhead.style.left = '0px';
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            currentStep.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            
            // –°–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥–∏
            dialogLeft.classList.remove('active');
            dialogRight.classList.remove('active');
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
        function updateZoom() {
            project.zoom = parseInt(zoomSlider.value);
            drawRuler();
            renderAllClips();
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–ª–∏–ø–æ–≤
        function renderAllClips() {
            // –û—á–∏—Å—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤
            dialogueTrack.innerHTML = '';
            sfxTrack.innerHTML = '';
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤
            project.dialogues.forEach(dialogue => {
                renderDialogueClip(dialogue);
            });
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            project.sfx.forEach(sfx => {
                renderSfxClip(sfx);
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ playhead
            playhead.style.left = `${playheadPosition * project.zoom}px`;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–ø–∞
        function deleteSelectedClip() {
            if (!selectedClip) return;
            
            if (selectedClip.type === 'dialogue') {
                project.dialogues = project.dialogues.filter(d => d.id !== selectedClip.id);
                const clipElement = document.getElementById(`clip-${selectedClip.id}`);
                if (clipElement) clipElement.remove();
            } else {
                project.sfx = project.sfx.filter(s => s.id !== selectedClip.id);
                const sfxElement = document.getElementById(`sfx-${selectedClip.id}`);
                if (sfxElement) sfxElement.remove();
            }
            
            selectedClip = null;
            updateClipInfo();
        }

        // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–ø–∞
        function duplicateSelectedClip() {
            if (!selectedClip) return;
            
            const duplicate = JSON.parse(JSON.stringify(selectedClip));
            duplicate.id = Date.now();
            duplicate.start += 2; // –°–¥–≤–∏–≥–∞–µ–º –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
            
            if (duplicate.type === 'dialogue') {
                project.dialogues.push(duplicate);
                renderDialogueClip(duplicate);
            } else {
                project.sfx.push(duplicate);
                renderSfxClip(duplicate);
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞
        function exportProject() {
            const projectData = JSON.stringify(project, null, 2);
            const blob = new Blob([projectData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = '–¥–∏–∞–ª–æ–≥-–ø—Ä–æ–µ–∫—Ç.json';
            a.click();
            
            URL.revokeObjectURL(url);
            currentStep.textContent = '–ü—Ä–æ–µ–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
        function saveProject() {
            localStorage.setItem('dialogueProject', JSON.stringify(project));
            currentStep.textContent = '–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage!';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        function loadProject() {
            const savedProject = localStorage.getItem('dialogueProject');
            if (savedProject) {
                project = JSON.parse(savedProject);
                renderAllClips();
                drawRuler();
                currentStep.textContent = '–ü—Ä–æ–µ–∫—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage!';
            } else {
                alert('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤');
            }
        }

        // –°–±—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–∞
        function resetProject() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                project = {
                    dialogues: [],
                    sfx: [],
                    duration: 60,
                    zoom: 10
                };
                
                stopTimeline();
                dialogueTrack.innerHTML = '';
                sfxTrack.innerHTML = '';
                selectedClip = null;
                updateClipInfo();
                zoomSlider.value = 10;
                drawRuler();
                
                currentStep.textContent = '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω';
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
